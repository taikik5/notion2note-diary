"""
OpenAI API module for formatting articles.
"""

import os
from openai import OpenAI


SYSTEM_PROMPT = """ã‚ãªãŸã¯ã€æ—¥è¨˜ã‚„ãƒ¡ãƒ¢ã‚’æ•´ç†ã—ã¦èª­ã¿ã‚„ã™ã„è¨˜äº‹ã«æ•´å½¢ã™ã‚‹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ä¸ãˆã‚‰ã‚ŒãŸé›‘å¤šãªãƒ¡ãƒ¢ã‚’ã€note.comç”¨ã®ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ã«æ•´å½¢ã—ã¦ãã ã•ã„ã€‚

# é‡è¦: note.comã®ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å¯¾å¿œãƒ«ãƒ¼ãƒ«

note.comã¯ä»¥ä¸‹ã®ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³è¨˜æ³•ã®ã¿å¯¾å¿œã—ã¦ã„ã¾ã™ï¼š
- å¤§è¦‹å‡ºã—: `## ` ï¼ˆã‚·ãƒ£ãƒ¼ãƒ—2ã¤ + åŠè§’ã‚¹ãƒšãƒ¼ã‚¹ï¼‰
- å°è¦‹å‡ºã—: `### ` ï¼ˆã‚·ãƒ£ãƒ¼ãƒ—3ã¤ + åŠè§’ã‚¹ãƒšãƒ¼ã‚¹ï¼‰
- ç®‡æ¡æ›¸ã: `- ` ï¼ˆãƒã‚¤ãƒ•ãƒ³ + åŠè§’ã‚¹ãƒšãƒ¼ã‚¹ï¼‰
- å¤ªå­—: `**ãƒ†ã‚­ã‚¹ãƒˆ**`

ã€çµ¶å¯¾ã«å®ˆã‚‹ã“ã¨ã€‘
1. `##` ã‚„ `###` ã®å¾Œã«ã¯å¿…ãšåŠè§’ã‚¹ãƒšãƒ¼ã‚¹ã‚’1ã¤å…¥ã‚Œã‚‹
2. `#`ï¼ˆh1ï¼‰ã¯ä½¿ã‚ãªã„ï¼ˆnote.comã§ã¯å¯¾å¿œå¤–ï¼‰
3. `####` ä»¥ä¸Šã¯ä½¿ã‚ãªã„ï¼ˆnote.comã§ã¯å¯¾å¿œå¤–ï¼‰
4. ç®‡æ¡æ›¸ãã¯ `- ` ã‚’ä½¿ã†ï¼ˆ`*` ã‚„ `â€¢` ã§ã¯ãªãï¼‰

# ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆè¦å‰‡

1. ã‚¿ã‚¤ãƒˆãƒ«ã¯ `ã€Logã€‘YYYY.MM.DD` ã®å½¢å¼ï¼ˆè¦‹å‡ºã—è¨˜å·ãªã—ï¼‰

2. ãƒ¡ã‚¤ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯ `## ` + çµµæ–‡å­— + ãƒ†ã‚­ã‚¹ãƒˆï¼ˆã‚«ãƒ†ã‚´ãƒªåˆ†é¡ã‚’é‡è¦–ï¼‰ï¼š
   - `## ğŸ“ ä»Šæ—¥ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ`
   - `## ğŸ’» Technical & Work`
   - `## âœï¸ Study & Skills`
   - `## ğŸ§  Career & Mindset`
   - `## ğŸ¥ Life & Health`
   - `## ğŸš€ Next Action`

3. å°è¦‹å‡ºã—ã¯ `### ` ã‚’ä½¿ç”¨

4. ç®‡æ¡æ›¸ãã¯ `- ` ã‚’ä½¿ç”¨ã—ã€è©³ç´°ãªèª¬æ˜ã‚’å«ã‚ã‚‹ï¼ˆå˜èªã®ç¾…åˆ—ã§ã¯ãªãã€å…·ä½“çš„ãªå†…å®¹ã‚’è¨˜è¼‰ï¼‰

5. é‡è¦ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ `**å¤ªå­—**` ã§å¼·èª¿

6. ã‚»ã‚¯ã‚·ãƒ§ãƒ³é–“ã¯ç©ºè¡Œ1è¡Œã§åŒºåˆ‡ã‚‹

7. è©²å½“ã™ã‚‹å†…å®¹ãŒã‚ã‚‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯è©³ç´°ã‚’å«ã‚ã¦è¨˜è¼‰ï¼ˆçœç•¥ã—ã™ããªã„ï¼‰

8. å…ƒã®ãƒ¡ãƒ¢ã®æƒ…å ±ã¯æ¼ã‚‰ã•ãšã€è©³ç´°ã«å«ã‚ã‚‹

9. å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®é …ç›®ã¯å˜ã«æƒ…å ±ã‚’åˆ—æŒ™ã™ã‚‹ã®ã§ã¯ãªãã€æ„å‘³ã®ã‚ã‚‹ã¾ã¨ã¾ã‚Šã§èª¬æ˜ã™ã‚‹

# å‡ºåŠ›å½¢å¼ã®å…·ä½“ä¾‹

ã€Logã€‘YYYY.MM.DD

## ğŸ“ ä»Šæ—¥ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ

- **é‡è¦ãªãƒˆãƒ”ãƒƒã‚¯1** - ãªãœé‡è¦ã‹ã€ã©ã†ã„ã£ãŸæˆæœã‚„å­¦ã³ãŒã‚ã£ãŸã‹ã‚’è©³ã—ãèª¬æ˜
- **é‡è¦ãªãƒˆãƒ”ãƒƒã‚¯2** - å…·ä½“çš„ãªå†…å®¹ã¨ãã®èƒŒæ™¯ã€å½±éŸ¿ã«ã¤ã„ã¦è©³ã—ãèª¬æ˜
- **é‡è¦ãªãƒˆãƒ”ãƒƒã‚¯3** - å®Ÿæ–½å†…å®¹ã¨å¾—ã‚‰ã‚ŒãŸæ°—ã¥ãã‚„æˆæœã‚’è©³ã—ãèª¬æ˜

## ğŸ’» Technical & Work

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆA

- å…·ä½“çš„ãªä½œæ¥­å†…å®¹ã¨å®Ÿæ–½ã—ãŸç†ç”±ã€å¾—ã‚‰ã‚ŒãŸçµæœã‚’è©³ã—ãèª¬æ˜
- æŠ€è¡“çš„ãªèª²é¡ŒãŒã‚ã‚Œã°ã€ãã®åŸå› ã¨æ¡ã£ãŸå¯¾ç­–ã«ã¤ã„ã¦è©³ã—ãèª¬æ˜

### æŠ€è¡“çš„ãªå­¦ç¿’

- **Python** - å­¦ç¿’ã—ãŸå†…å®¹ã€å®Ÿè£…ã—ãŸæ©Ÿèƒ½ã€ç›´é¢ã—ãŸèª²é¡Œã¨è§£æ±ºæ–¹æ³•
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹** - å­¦ç¿’ãƒ†ãƒ¼ãƒã€å®Ÿéš›ã®å¿œç”¨ã‚·ãƒ¼ãƒ³ã€ä»Šå¾Œã®æ´»ç”¨äºˆå®š

## âœï¸ Study & Skills

### è¨€èªå­¦ç¿’

- è‹±èªã®å‹‰å¼·: 30åˆ†å®Ÿæ–½ã€‚å…·ä½“çš„ãªå­¦ç¿’å†…å®¹ï¼ˆä½•ã‚’å­¦ã‚“ã ã‹ï¼‰ã¨é€²æ—çŠ¶æ³
- ç¿’å¾—çŠ¶æ³: å¾—ã‚‰ã‚ŒãŸçŸ¥è­˜ã‚„å®Ÿè·µã§ã®å¿œç”¨ã«ã¤ã„ã¦

## ğŸ§  Career & Mindset

- ã‚­ãƒ£ãƒªã‚¢ç™ºå±•ã«é–¢ã™ã‚‹è€ƒãˆã€æ°—ã¥ãã€å®Ÿæ–½ã—ãŸæ–½ç­–ã¨ãã®çµæœã‚’è©³ã—ãèª¬æ˜

## ğŸ¥ Life & Health

- é‹å‹•: å®Ÿæ–½ã—ãŸé‹å‹•å†…å®¹ã€æ™‚é–“ã€åŠ¹æœã‚„æ„Ÿæƒ³ã‚’è©³ã—ãèª¬æ˜
- ç¡çœ : ç¡çœ æ™‚é–“ã¨è³ªã€ç¡çœ ã«é–¢ã™ã‚‹æ°—ã¥ãã‚„æ”¹å–„ç­–

## ğŸš€ Next Action

- æ˜æ—¥ä»¥é™ã®å„ªå…ˆã‚¿ã‚¹ã‚¯1: æœŸé™ã¨å®Ÿæ–½ç†ç”±ã‚’å«ã‚ã¦è©³ã—ãèª¬æ˜
- æ˜æ—¥ä»¥é™ã®å„ªå…ˆã‚¿ã‚¹ã‚¯2: æœŸé™ã¨å®Ÿæ–½ç†ç”±ã‚’å«ã‚ã¦è©³ã—ãèª¬æ˜
- æ˜æ—¥ä»¥é™ã®å„ªå…ˆã‚¿ã‚¹ã‚¯3: æœŸé™ã¨å®Ÿæ–½ç†ç”±ã‚’å«ã‚ã¦è©³ã—ãèª¬æ˜

---

### ã‚ã¨ãŒã

æœ¬æ—¥ã®å…¨ä½“çš„ãªæ„Ÿæƒ³ã€æ°—ã¥ãã€æ˜æ—¥ã¸ã®æ±ºæ„ã‚„å·¥å¤«äºˆå®šã‚’è©³ã—ãè¨˜è¼‰ã€‚
"""


def format_article(memo_content: str, date: str) -> tuple[str, str]:
    """
    Format memo content into a structured article using OpenAI API.

    Args:
        memo_content: Raw memo content from Notion
        date: Date string in YYYY.MM.DD format

    Returns:
        Tuple of (title, formatted_body)
    """
    api_key = os.environ.get("OPENAI_API_KEY")
    if not api_key:
        raise ValueError("OPENAI_API_KEY environment variable is not set")

    # Get model from environment variable, default to gpt-4o-mini
    model = os.environ.get("OPENAI_MODEL", "gpt-4o-mini")

    client = OpenAI(api_key=api_key)

    user_message = f"""ä»¥ä¸‹ã®ãƒ¡ãƒ¢ã‚’æ•´å½¢ã—ã¦ãã ã•ã„ã€‚

æ—¥ä»˜: {date}

---
ãƒ¡ãƒ¢å†…å®¹:
{memo_content}
---

ä¸Šè¨˜ã®ãƒ¡ãƒ¢ã‚’ã€æŒ‡å®šã•ã‚ŒãŸãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¾“ã£ã¦æ•´å½¢ã—ã¦ãã ã•ã„ã€‚
ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼ˆ```markdown ãªã©ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã§å›²ã¾ãªã„ã§ãã ã•ã„ï¼‰ã€‚
"""

    message = client.chat.completions.create(
        model=model,
        max_tokens=4096,
        messages=[
            {
                "role": "system",
                "content": SYSTEM_PROMPT
            },
            {
                "role": "user",
                "content": user_message
            }
        ]
    )

    formatted_content = message.choices[0].message.content

    # Extract title and body
    lines = formatted_content.strip().split("\n")
    title = ""
    body_lines = []

    for i, line in enumerate(lines):
        # Match both "# ã€Logã€‘" (old format) and "ã€Logã€‘" (new format)
        if line.strip().startswith("ã€Logã€‘"):
            title = line.lstrip("# ").strip()
            body_lines = lines[i + 1:]
            break

    body = "\n".join(body_lines).strip()

    # If title extraction failed, use default
    if not title:
        title = f"ã€Logã€‘{date}"
        body = formatted_content

    return title, body


if __name__ == "__main__":
    # Test execution
    from dotenv import load_dotenv
    load_dotenv()

    test_memo = """
    ä»Šæ—¥ã¯Pythonã§ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã®ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ãŸã€‚
    BeautifulSoupã‚ˆã‚ŠPlaywrightã®æ–¹ãŒä½¿ã„ã‚„ã™ã„æ°—ãŒã™ã‚‹ã€‚
    è‹±èªã®å‹‰å¼·ã‚‚30åˆ†ãã‚‰ã„ã‚„ã£ãŸã€‚
    å¤œã¯æ—©ãå¯ãŸã„ã€‚
    æ˜æ—¥ã¯ä¼šè­°ãŒã‚ã‚‹ã€‚
    """

    title, body = format_article(test_memo, "2024.01.15")
    print(f"Title: {title}")
    print(f"\nBody:\n{body}")
