"""
OpenAI API module for formatting articles.
"""

import os
from openai import OpenAI


SYSTEM_PROMPT = """ã‚ãªãŸã¯ã€æ—¥è¨˜ã‚„ãƒ¡ãƒ¢ã‚’æ•´ç†ã—ã¦èª­ã¿ã‚„ã™ã„è¨˜äº‹ã«æ•´å½¢ã™ã‚‹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ä¸ãˆã‚‰ã‚ŒãŸé›‘å¤šãªãƒ¡ãƒ¢ã‚’ã€ä»¥ä¸‹ã®Markdownãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å³å¯†ã«å¾“ã£ã¦æ•´å½¢ã—ã¦ãã ã•ã„ã€‚
note.comã§ã®ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³è¨˜æ³•ã‚’æ´»ç”¨ã—ã¦ã€è¦–è¦šçš„ã«åˆ†ã‹ã‚Šã‚„ã™ã„æ§‹æˆã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚

# é‡è¦: ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³è¨˜æ³•ã®ãƒ«ãƒ¼ãƒ«

**è¦‹å‡ºã—ã«ã¯å¿…ãš # ã®å¾Œã«ã‚¹ãƒšãƒ¼ã‚¹ã‚’å…¥ã‚Œã¦ãã ã•ã„ï¼š**
- æ­£ã—ã„: `## è¦‹å‡ºã—` ï¼ˆ##ã®å¾Œã«ã‚¹ãƒšãƒ¼ã‚¹ï¼‰
- é–“é•ã„: `##è¦‹å‡ºã—` ï¼ˆã‚¹ãƒšãƒ¼ã‚¹ãªã—ï¼‰

ã“ã‚Œã¯note.comã§æ­£ã—ãè¦‹å‡ºã—ã¨ã—ã¦èªè­˜ã•ã‚Œã‚‹ãŸã‚ã«å¿…é ˆã§ã™ã€‚

# ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆè¦å‰‡

1. ã‚¿ã‚¤ãƒˆãƒ«ã¯ `# ã€Logã€‘YYYY.MM.DD` ã®å½¢å¼ã«ã—ã¦ãã ã•ã„ï¼ˆæ—¥ä»˜ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰æä¾›ã•ã‚Œã¾ã™ï¼‰

2. ãƒ¡ã‚¤ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ`## è¦‹å‡ºã—`ï¼‰ã®å¾Œã«ã€é–¢é€£ã™ã‚‹å°è¦‹å‡ºã—ï¼ˆ`### ã‚µãƒ–è¦‹å‡ºã—`ï¼‰ã‚’é©åˆ‡ã«è¿½åŠ ã—ã¦ãã ã•ã„ï¼š
   - `## ğŸ“ ä»Šæ—¥ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ` - æœ€ã‚‚é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã‚’ç®‡æ¡æ›¸ãã§ç°¡æ½”ã«ã¾ã¨ã‚ã‚‹
   - `## ğŸ’» Technical & Work` - æŠ€è¡“çš„ãªå†…å®¹ã‚„ä»•äº‹ã«é–¢ã™ã‚‹ãƒ¡ãƒ¢
   - `## âœï¸ Study & Skills` - å­¦ç¿’ã‚„è‡ªå·±ç ”é‘½ã«é–¢ã™ã‚‹å†…å®¹
   - `## ğŸ§  Career & Mindset` - ã‚­ãƒ£ãƒªã‚¢ã‚„è€ƒãˆæ–¹ã«é–¢ã™ã‚‹å†…å®¹
   - `## ğŸ¥ Life & Health` - ç”Ÿæ´»ã‚„å¥åº·ã«é–¢ã™ã‚‹å†…å®¹
   - `## ğŸš€ Next Action` - æ¬¡ã«ã‚„ã‚‹ã¹ãã“ã¨ã®ãƒªã‚¹ãƒˆ

3. ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³è¨˜æ³•ã‚’æ´»ç”¨ã—ã¦å¯èª­æ€§ã‚’å‘ä¸Šã•ã›ã¦ãã ã•ã„ï¼š
   - **é‡è¦ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰**ã¯ `**å¤ªå­—**` ã§å¼·èª¿ã™ã‚‹
   - `ã‚³ãƒ¼ãƒ‰` ã‚„ `ãƒ•ã‚¡ã‚¤ãƒ«å` ã¯ãƒãƒƒã‚¯ã‚¯ã‚©ãƒ¼ãƒˆã§å›²ã‚€
   - è¤‡æ•°ã®é …ç›®ã¯ãƒªã‚¹ãƒˆå½¢å¼ï¼ˆ`* ` ã¾ãŸã¯ `- `ï¼‰ã‚’ä½¿ç”¨ã™ã‚‹ï¼ˆè¨˜å·ã®å¾Œã«ã‚¹ãƒšãƒ¼ã‚¹å¿…é ˆï¼‰
   - é–¢é€£å†…å®¹ã¯ `### å°è¦‹å‡ºã—` ã§æ§‹é€ åŒ–ã™ã‚‹ï¼ˆ###ã®å¾Œã«ã‚¹ãƒšãƒ¼ã‚¹å¿…é ˆï¼‰
   - é‡è¦ãªæƒ…å ±ã¯é©åˆ‡ã«ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ†ã‘ã™ã‚‹

4. å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æ§‹æˆä¾‹ï¼š
   - ãƒ¡ã‚¤ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…ã§ã€ãƒˆãƒ”ãƒƒã‚¯ã”ã¨ã« `### å°è¦‹å‡ºã—` ã‚’ä»˜ã‘ã‚‹
   - è¤‡æ•°ã®ãƒˆãƒ”ãƒƒã‚¯ãŒã‚ã‚‹å ´åˆã¯ã€ãƒˆãƒ”ãƒƒã‚¯ã”ã¨ã«å°è¦‹å‡ºã—ã‚’è¿½åŠ 
   - ãƒªã‚¹ãƒˆé …ç›®ã¯ `* ` ã¾ãŸã¯ `- ` ã‚’ä½¿ç”¨ï¼ˆã‚¹ãƒšãƒ¼ã‚¹å¿…é ˆï¼‰
   - é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã«ã¯ `**å¤ªå­—**` ã‚’ä½¿ç”¨

5. åŒºåˆ‡ã‚Šç·š `---` ã®å¾Œã« `### ã‚ã¨ãŒã` ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¨­ã‘ã€ãã®æ—¥ã®æ„Ÿæƒ…ã‚„ä¸€è¨€ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã

6. è©²å½“ã™ã‚‹å†…å®¹ãŒãªã„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯ã€Œç‰¹ã«ãªã—ã€ã¨è¨˜è¼‰ã™ã‚‹ã‹ã€çœç•¥ã—ã¦ãã ã•ã„

7. å…ƒã®ãƒ¡ãƒ¢ã®æƒ…å ±ã¯æ¼ã‚‰ã•ãšå«ã‚ã¤ã¤ã€èª­ã¿ã‚„ã™ãæ•´ç†ã—ã¦ãã ã•ã„

# å‡ºåŠ›å½¢å¼ã®å…·ä½“ä¾‹

# ã€Logã€‘YYYY.MM.DD

## ğŸ“ ä»Šæ—¥ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ

* **é‡è¦ãªãƒˆãƒ”ãƒƒã‚¯1** - ç°¡æ½”ãªèª¬æ˜
* **é‡è¦ãªãƒˆãƒ”ãƒƒã‚¯2** - ç°¡æ½”ãªèª¬æ˜
* **é‡è¦ãªãƒˆãƒ”ãƒƒã‚¯3** - ç°¡æ½”ãªèª¬æ˜

## ğŸ’» Technical & Work

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆA

* é€²æ—1
* é€²æ—2

### æŠ€è¡“çš„ãªå­¦ç¿’

* **Python** - å…·ä½“çš„ãªå†…å®¹
* **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹** - å…·ä½“çš„ãªå†…å®¹

## âœï¸ Study & Skills

### è¨€èªå­¦ç¿’

* è‹±èªã®å‹‰å¼·æ™‚é–“: 30åˆ†
* å­¦ç¿’å†…å®¹: â—‹â—‹ã«ã¤ã„ã¦å­¦ã‚“ã 

### ãã®ä»–ã®ã‚¹ã‚­ãƒ«

* ç¶šãã®å†…å®¹

## ğŸ§  Career & Mindset

ç‰¹ã«ãªã—

## ğŸ¥ Life & Health

* é‹å‹•: â—‹â—‹ã‚’ã—ãŸ
* ç¡çœ : â—‹æ™‚é–“

## ğŸš€ Next Action

* [ ] ã‚¿ã‚¹ã‚¯1
* [ ] ã‚¿ã‚¹ã‚¯2
* [ ] ã‚¿ã‚¹ã‚¯3

---

### ã‚ã¨ãŒã

æœ¬æ—¥ã®ä¸€è¨€ã‚„æ„Ÿæƒ…ã‚’è¨˜è¼‰ã—ã¾ã™ã€‚
"""


def format_article(memo_content: str, date: str) -> tuple[str, str]:
    """
    Format memo content into a structured article using OpenAI API.

    Args:
        memo_content: Raw memo content from Notion
        date: Date string in YYYY.MM.DD format

    Returns:
        Tuple of (title, formatted_body)
    """
    api_key = os.environ.get("OPENAI_API_KEY")
    if not api_key:
        raise ValueError("OPENAI_API_KEY environment variable is not set")

    client = OpenAI(api_key=api_key)

    user_message = f"""ä»¥ä¸‹ã®ãƒ¡ãƒ¢ã‚’æ•´å½¢ã—ã¦ãã ã•ã„ã€‚

æ—¥ä»˜: {date}

---
ãƒ¡ãƒ¢å†…å®¹:
{memo_content}
---

ä¸Šè¨˜ã®ãƒ¡ãƒ¢ã‚’ã€æŒ‡å®šã•ã‚ŒãŸãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¾“ã£ã¦æ•´å½¢ã—ã¦ãã ã•ã„ã€‚
ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼ˆ```markdown ãªã©ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã§å›²ã¾ãªã„ã§ãã ã•ã„ï¼‰ã€‚
"""

    message = client.chat.completions.create(
        model="gpt-4o",
        max_tokens=4096,
        messages=[
            {
                "role": "system",
                "content": SYSTEM_PROMPT
            },
            {
                "role": "user",
                "content": user_message
            }
        ]
    )

    formatted_content = message.choices[0].message.content

    # Extract title and body
    lines = formatted_content.strip().split("\n")
    title = ""
    body_lines = []

    for i, line in enumerate(lines):
        if line.startswith("# ã€Logã€‘"):
            title = line.lstrip("# ").strip()
            body_lines = lines[i + 1:]
            break

    body = "\n".join(body_lines).strip()

    # If title extraction failed, use default
    if not title:
        title = f"ã€Logã€‘{date}"
        body = formatted_content

    return title, body


if __name__ == "__main__":
    # Test execution
    from dotenv import load_dotenv
    load_dotenv()

    test_memo = """
    ä»Šæ—¥ã¯Pythonã§ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã®ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ãŸã€‚
    BeautifulSoupã‚ˆã‚ŠPlaywrightã®æ–¹ãŒä½¿ã„ã‚„ã™ã„æ°—ãŒã™ã‚‹ã€‚
    è‹±èªã®å‹‰å¼·ã‚‚30åˆ†ãã‚‰ã„ã‚„ã£ãŸã€‚
    å¤œã¯æ—©ãå¯ãŸã„ã€‚
    æ˜æ—¥ã¯ä¼šè­°ãŒã‚ã‚‹ã€‚
    """

    title, body = format_article(test_memo, "2024.01.15")
    print(f"Title: {title}")
    print(f"\nBody:\n{body}")
